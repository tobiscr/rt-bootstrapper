name: rt-bootstrapper-e2e.yml
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - .reuse
      - LICENSES/
      - LICENSE
      - .gitignore
      - "**.md"

permissions:
  id-token: write # This is required for requesting the JWT token
  contents: read # This is required for actions/checkout

env:
  K3D_VERSION: v5.8.3

jobs:
  rt-bootstrapper-registry-check:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
    - name: Clone the code
      uses: actions/checkout@v4
    - name: Install k3d
      run: |
        mkdir -p $HOME/bin
        curl -Lo $HOME/bin/k3d https://github.com/k3d-io/k3d/releases/download/${{env.K3D_VERSION}}/k3d-linux-amd64
        chmod +x $HOME/bin/k3d
        echo "$HOME/bin" >> $GITHUB_PATH
    - name: Setup k3d cluster, Docker registry and rt-bootstrapper controller
      run: |
          cd hack/rt-cicd-tests
          chmod +x ./setup-k3d-registry-bootstrapper.sh
          ./setup-k3d-registry-bootstrapper.sh
      shell: bash